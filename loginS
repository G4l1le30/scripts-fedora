#!/usr/bin/env python3
import getpass
import json
import os

from dotenv import load_dotenv
from playwright.sync_api import sync_playwright, TimeoutError

# Muat variabel dari file .env
load_dotenv()

# Ambil konfigurasi dari environment variables
DEFAULT_USERNAME = os.getenv("DEFAULT_USERNAME")
DEFAULT_PASSWORD = os.getenv("DEFAULT_PASSWORD")


def run(playwright):
    # Meminta username dari pengguna
    username_input = input(
        f"Masukkan username Anda (kosongkan untuk default: {DEFAULT_USERNAME}): "
    )

    if username_input:
        # Jika pengguna memasukkan username, minta password
        username = username_input
        password = getpass.getpass("Masukkan password Anda: ")
    else:
        # Jika pengguna tidak memasukkan apa-apa, gunakan nilai default
        username = DEFAULT_USERNAME
        password = DEFAULT_PASSWORD
        print(f"Menggunakan username default: {username}")

    if not password:
        print("Password tidak boleh kosong.")
        return

    browser = playwright.firefox.launch(
        headless=False
    )  # Gunakan headless=False untuk melihat browser
    context = browser.new_context()
    page = context.new_page()

    try:
        # Buka halaman login
        print("Membuka halaman login...")
        page.goto("https://siam.ub.ac.id/")

        # Klik tombol "LOGIN UB"
        print("Mengklik tombol 'LOGIN UB'...")
        page.click('button:has-text("LOGIN UB")')

        # Tunggu hingga form login muncul (misalnya, dengan menunggu input username)
        page.wait_for_selector("input[name='username']")

        # Mengisi form login
        print("Mengisi username dan password...")
        page.fill("input[name='username']", username)
        page.fill("input[name='password']", password)

        # Klik tombol "Sign In"
        print("Mengklik tombol 'Sign In'...")
        page.click("#kc-login")

        # Tunggu hingga halaman mahasiswa dimuat dan dashboard terlihat
        print("Menunggu halaman mahasiswa...")
        page.wait_for_selector('a.menu-link[href="https://siam.ub.ac.id/mahasiswa"]')
        print("Berhasil masuk ke halaman mahasiswa.")

        # Navigasi ke halaman presensi terlebih dahulu
        print("Menavigasi ke halaman presensi...")
        page.goto("https://siam.ub.ac.id/mahasiswa/presensi")

        # Tunggu hingga elemen statis halaman dimuat
        page.wait_for_selector("h4.card-title:has-text('Presensi Kehadiran Online')")
        print("Halaman presensi dimuat. Mencari tombol presensi...")

        try:
            hadir_luring_button_selector = 'button:has-text("Hadir Luring")'
            
            print("Menunggu tombol 'Hadir Luring' muncul (maksimal 10 detik)...")
            page.wait_for_selector(hadir_luring_button_selector, timeout=10000)
            luring_button = page.query_selector(hadir_luring_button_selector)

            if luring_button and luring_button.is_visible():
                print("Menemukan tombol 'Hadir Luring'.")
                
                try:
                    # Try to find the course name for context from the button's ancestor element
                    list_item = luring_button.query_selector('xpath=ancestor::div[contains(@class, "list-group-item")]')
                    if list_item:
                        course_name_element = list_item.query_selector('h4 > b')
                        if course_name_element:
                            course_name = course_name_element.inner_text()
                            print(f"Mencoba presensi untuk mata kuliah: {course_name}")
                except Exception:
                    # This part is for logging, so if it fails, we can just print a message and proceed.
                    print("Tidak dapat menemukan nama mata kuliah, melanjutkan proses presensi...")

                print("Mengklik tombol 'Hadir Luring'...")
                luring_button.click()
                
                # Wait for the confirmation popup
                print("Menunggu popup konfirmasi...")
                popup_confirm_button_selector = 'button.swal2-confirm:has-text("Proses")'
                try:
                    page.wait_for_selector(popup_confirm_button_selector, timeout=5000)
                    confirm_button = page.query_selector(popup_confirm_button_selector)
                    
                    if confirm_button and confirm_button.is_visible():
                        print("Popup konfirmasi ditemukan. Mengklik tombol 'Proses'...")
                        confirm_button.click()
                        
                        # Wait for the action to complete
                        page.wait_for_timeout(3000)
                        print("Selesai. Kehadiran luring seharusnya sudah dikonfirmasi.")
                    else:
                        print("Tombol 'Proses' pada popup tidak ditemukan.")

                except TimeoutError:
                    print("Popup konfirmasi tidak muncul dalam 5 detik.")
                
            else:
                # This case is unlikely if wait_for_selector succeeds
                print("Tombol 'Hadir Luring' tidak terlihat meskipun elemennya ada.")

        except TimeoutError:
             print("Tidak ada presensi yang sedang berjalan (tombol 'Hadir Luring' tidak ditemukan dalam 10 detik).")
        except Exception as e:
            print(f"Terjadi kesalahan saat mencoba melakukan presensi: {e}")

    except Exception as e:
        print(f"Terjadi kesalahan: {e}")
        # Simpan screenshot halaman saat ini untuk debugging
        error_screenshot_path = "halaman_error.png"
        page.screenshot(path=error_screenshot_path)
        print(
            f"Screenshot halaman error disimpan di: {os.path.abspath(error_screenshot_path)}"
        )

    finally:
        # Tutup browser
        browser.close()


with sync_playwright() as playwright:
    run(playwright)