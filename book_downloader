#!/usr/bin/env python3
import argparse
import json
import os
import sys

import requests
from dotenv import load_dotenv

# Load environment variables from .env file
load_dotenv()

# Get API key and host from environment variables
API_KEY = os.getenv("RAPIDAPI_KEY")
API_HOST = os.getenv("RAPIDAPI_HOST")

if not API_KEY or not API_HOST:
    print(
        "Error: PASTIKAN RAPIDAPI_KEY dan RAPIDAPI_HOST sudah diatur di file .env Anda."
    )
    sys.exit(1)

SEARCH_URL = f"https://{API_HOST}/search"
DOWNLOAD_URL = f"https://{API_HOST}/download"


def search_books(query, extension=None):
    """Searches for books using the Anna's Archive API, with an optional filetype filter."""
    print(
        f"Mencari '{query}'"
        + (f" dengan filter ekstensi '{extension}'..." if extension else "...")
    )
    headers = {"x-rapidapi-key": API_KEY, "x-rapidapi-host": API_HOST}
    params = {"q": query, "sort": "mostRelevant"}
    if extension:
        params["ext"] = extension

    try:
        response = requests.get(SEARCH_URL, headers=headers, params=params)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"Error saat pencarian: {e}")
        return None


def download_book(md5, output_filename):
    """Gets download links and attempts to download the book from each available link."""
    print(f"Mendapatkan link unduhan untuk md5: {md5}")
    headers = {"x-rapidapi-key": API_KEY, "x-rapidapi-host": API_HOST}
    params = {"md5": md5}
    try:
        response = requests.get(DOWNLOAD_URL, headers=headers, params=params)
        print(f"response status: {response.status_code}")
        print(response.text)
        response.raise_for_status()
        download_links = response.json()

        if not download_links or not isinstance(download_links, list):
            print(
                "Tidak ada link unduhan yang ditemukan atau format respons tidak terduga."
            )
            return

        download_successful = False
        for i, link in enumerate(download_links):
            print(f"\nMencoba mengunduh dari link #{i + 1}: {link}...")
            try:
                with requests.get(link, stream=True, timeout=30) as r:
                    r.raise_for_status()
                    total_size = int(r.headers.get("content-length", 0))

                    with open(output_filename, "wb") as f:
                        for chunk in r.iter_content(chunk_size=8192):
                            f.write(chunk)

                    # Verify if the downloaded file size matches the expected size
                    if (
                        total_size != 0
                        and os.path.getsize(output_filename) < total_size
                    ):
                        raise requests.exceptions.RequestException(
                            "Unduhan tidak lengkap."
                        )

                print(f"Berhasil mengunduh '{output_filename}'")
                download_successful = True
                break  # Exit loop on successful download

            except requests.exceptions.RequestException as e:
                print(f"Gagal mengunduh dari link #{i + 1}. Error: {e}")
                # Clean up incomplete file if it exists
                if os.path.exists(output_filename):
                    os.remove(output_filename)
                continue  # Try the next link

        if not download_successful:
            print("\nSemua link unduhan gagal. Tidak dapat mengunduh buku.")

    except requests.exceptions.RequestException as e:
        print(f"Error saat mengambil daftar link unduhan: {e}")
    except (json.JSONDecodeError, IndexError, TypeError) as e:
        print(f"Error saat memproses respons unduhan: {e}")


def main():
    """Main function to run the script."""
    parser = argparse.ArgumentParser(
        description="Cari dan unduh buku dari Anna's Archive."
    )
    parser.add_argument("query", type=str, help="Judul buku yang ingin dicari.")
    parser.add_argument(
        "-e",
        "--extension",
        type=str,
        help="Filter hasil berdasarkan ekstensi file (misal: pdf, epub, mobi).",
    )

    args = parser.parse_args()

    results_data = search_books(args.query, args.extension)

    if not results_data or "books" not in results_data or not results_data["books"]:
        print("Tidak ada hasil yang ditemukan.")
        return

    book_list = results_data["books"]

    print("\n--- Hasil Pencarian ---")
    for i, item in enumerate(book_list):
        title = item.get("title", "No Title")
        author = item.get("author", "No Author")
        file_format = item.get("format", "N/A")
        size = item.get("size", "N/A")
        print(f"{i + 1}. {title} - {author} [{file_format}, {size}]")

    print("--------------------")

    try:
        choice = int(input("Masukkan nomor buku untuk diunduh (atau 0 untuk keluar): "))
        if choice == 0:
            return
        if not (1 <= choice <= len(book_list)):
            print("Pilihan tidak valid.")
            return

        selected_book = book_list[choice - 1]
        md5_hash = selected_book.get("md5")

        if not md5_hash:
            print("Tidak dapat menemukan hash md5 untuk buku yang dipilih.")
            return

        safe_title = "".join(
            c
            for c in selected_book.get("title", "book")
            if c.isalnum() or c in (" ", "_", "-")
        ).rstrip()
        if len(safe_title) > 100:
            safe_title = safe_title[:100]

        filename = (
            f"{safe_title.replace(' ', '_')}.{selected_book.get('format', 'epub')}"
        )

        download_book(md5_hash, filename)

    except ValueError:
        print("Silakan masukkan nomor yang valid.")
    except KeyboardInterrupt:
        print("\nProses dibatalkan.")


if __name__ == "__main__":
    main()
